sqlplus/nolog
connect djohnson/LobosRhi1!@ODSPEU1.ams
set echo off
set feedback off
set colsep ';'
set sqlprompt ''
set headsep off
set serveroutput on size unlimited
set linesize 30000
set trimspool on
set pagesize 0
set heading on
set trimout on
set wrap off
set termout off
spo U:\barclays_theoretical_dataset_12.txt
select 
MERCHANT_NUMBER AS GROUP_NUMBER
,CID
,OUTLET_NAME AS MERCHANT_NAME
,MM.CLIENT_NAME
,EXTRACT(MONTH FROM CAST(TRANSACTION_DATE AS DATE)) AS MONTH
,CARD_SCHEME_DESCRIPTION AS BRAND
,case when CARD_TYPE_GROUP_DESCRIPTION = 'BUSINESS' then 'Credit'
    when CARD_TYPE_GROUP_DESCRIPTION = 'CORPORATE' then 'Credit'
    when CARD_TYPE_GROUP_DESCRIPTION = 'CREDIT' then 'Credit'
    when CARD_TYPE_GROUP_DESCRIPTION = 'DEBIT' then 'Debit'
    when CARD_TYPE_GROUP_DESCRIPTION = 'PURCHASE' then 'Credit'    
end as CARD_TYPE_GROUP_DESCRIPTION
,case when TRADING_COUNTRY_CODE = 'ES' then 'Spain'
    when TRADING_COUNTRY_CODE = 'CH' then 'Switzerland'
    when TRADING_COUNTRY_CODE = 'FR' then 'France'
    when TRADING_COUNTRY_CODE = 'IT' then 'Italy'
    when TRADING_COUNTRY_CODE = 'BE' then 'Belgium'
    when TRADING_COUNTRY_CODE = 'CY' then 'Cyprus'
    when TRADING_COUNTRY_CODE = 'FI' then 'Finland'
    when TRADING_COUNTRY_CODE = 'GR' then 'Greece'
    when TRADING_COUNTRY_CODE = 'IL' then 'Israel'
    when TRADING_COUNTRY_CODE = 'DK' then 'Denmark'
    when TRADING_COUNTRY_CODE = 'IE' then 'Ireland'
    when TRADING_COUNTRY_CODE = 'PT' then 'Portugal'
    when TRADING_COUNTRY_CODE = 'NO' then 'Norway'
    when TRADING_COUNTRY_CODE = 'SE' then 'Sweden'
    when TRADING_COUNTRY_CODE = 'GB' then 'UK'
    when TRADING_COUNTRY_CODE = 'AT' then 'Austria'
    when TRADING_COUNTRY_CODE = 'DE' then 'Germany'
    when TRADING_COUNTRY_CODE = 'BG' then 'Bulgaria'
    when TRADING_COUNTRY_CODE = 'RO' then 'Romania'
    when TRADING_COUNTRY_CODE = 'PL' then 'Poland'
    when TRADING_COUNTRY_CODE = 'NL' then 'Netherlands'
end AS MERCHANT_COUNTRY
,CARD_ISSUING_COUNTRY AS ISSUER_COUNTRY
,case when CARD_ISSUER_REGION_DESCRIP = 'INTRA-E' then 'Intra-Region'
    when CARD_ISSUER_REGION_DESCRIP = 'INTRA-W' then 'Intra-Region'
    when CARD_ISSUER_REGION_DESCRIP = 'INTRA' then 'Intra-Region'
    when CARD_ISSUER_REGION_DESCRIP = 'INTER' then 'Inter-Region'
    when CARD_ISSUER_REGION_DESCRIP = 'DOMESTIC' then 'Domestic'
end as REGIONALITY
,Security_Level
,SCHEME_FEE_PERCENTAGE_FEE
,SCHEME_FEE_FIXED_FEE
,TRANSACTION_CURRENCY
,SETTLEMENT_CURRENCY
,ACQ_PRICING_TYPE
,PRODUCT_CODE
,MM.INVOICE_RELATION_ID
,CASE WHEN TRANSACTION_TYPE='TRANSACTION' then 'Sale'
WHEN TRANSACTION_TYPE='REFUND' then 'Refund'
END AS TRANSACTION_TYPE
,SUM(VOLUME) AS VOLUME
,SUM(TRANSACTION_FLOW_EUR) AS FLOW_EUR
,SUM(SCHEME_FEE_EUR) AS TOTAL_SCHEME_FEES     
from    
    (
    select b.*,t1.CONTRACT_ID AS CID
    from FDWO.ACQUIRER_BARCLAYS_DAILY b
    LEFT JOIN 
        (
        select OUTLET_TRADING_NAME,OUTLET_NUMBER,CONTRACT_ID
        from FDWO.ACQUIRER_BARCLAYS_COST_2017 b2
        WHERE DATA_MONTH BETWEEN TO_DATE('1/1/2018','MM/DD/YYYY') AND TO_DATE('12/31/2018','MM/DD/YYYY') 
        GROUP BY OUTLET_TRADING_NAME,OUTLET_NUMBER,CONTRACT_ID
        ORDER BY OUTLET_TRADING_NAME
        )t1
    on B.OUTLET_NUMBER=t1.OUTLET_NUMBER
    WHERE B.TRANSACTION_TYPE in('TRANSACTION','REFUND')
    )
LEFT JOIN
FDWO.MB_MERCHANTS mm
ON CID=MM.CONTRACT_ID
cross join (select 'Nonsecure' as Security_Level from dual)
WHERE CARD_ISSUING_COUNTRY IS NOT NULL
HAVING SUM(SCHEME_FEE_EUR) >0
GROUP BY
MERCHANT_NUMBER
,CID
,OUTLET_NAME
,CLIENT_NAME
,EXTRACT(MONTH FROM CAST(TRANSACTION_DATE AS DATE))
,CARD_TYPE_GROUP_DESCRIPTION
,CARD_SCHEME_DESCRIPTION
,CARD_ISSUING_COUNTRY
,TRADING_COUNTRY_CODE
,CARD_ISSUER_REGION_DESCRIP
,SCHEME_FEE_PERCENTAGE_FEE
,SCHEME_FEE_FIXED_FEE
,Security_Level
,TRANSACTION_CURRENCY
,SETTLEMENT_CURRENCY
,ACQ_PRICING_TYPE
,PRODUCT_CODE
,MM.INVOICE_RELATION_ID
,TRANSACTION_TYPE 
ORDER BY MONTH,MERCHANT_NAME,BRAND,ISSUER_COUNTRY,MERCHANT_COUNTRY ASC;
spo end